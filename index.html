<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–î–ª—è –º–æ–µ–π –ó–µ—Ñ–∏—Ä–∫–∏</title>
<style>
:root{
  --accent:#ff4b5c;
  --accent-dark:#e53b4c;
  --glass:rgba(255,255,255,0.10);
  --glass-hover:rgba(255,255,255,0.20);
  --nav-height:64px;
  --max-content-width:1100px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; -webkit-font-smoothing:antialiased;}
body{
  margin:0;
  padding-top: var(--nav-height); /* —á—Ç–æ–±—ã nav –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª –∫–æ–Ω—Ç–µ–Ω—Ç */
  background: url("background.jpg") no-repeat center center/cover;
  background-size: cover;
  color: white;
  text-align: center;
  overflow-x: hidden;
}

/* NAV */
nav{
  height: var(--nav-height);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  position:fixed;
  left:0; right:0; top:0;
  z-index:999;
  background: transparent;
  backdrop-filter: blur(4px);
  border-bottom: 1px solid rgba(255,255,255,0.03);
}
nav button{
  padding: 10px 18px;
  min-width:88px;
  border-radius:24px;
  border:1px solid rgba(255,255,255,0.12);
  background:var(--glass);
  color:white;
  font-weight:700;
  cursor:pointer;
  transition: transform .15s ease, background .15s ease;
  box-shadow:0 4px 16px rgba(0,0,0,0.18);
}
nav button:hover{ background: var(--glass-hover); transform: translateY(-2px); }
nav button.active{ background: rgba(255,255,255,0.18); outline: 2px solid rgba(255,255,255,0.06); }

/* Tabs area */
.tab{ display:none; padding:18px 12px 60px; min-height: calc(100vh - var(--nav-height)); align-items:center; justify-content:flex-start; box-sizing:border-box; }
.tab.active{ display:flex; flex-direction:column; }

/* HOME */
h1{ font-size:2.2rem; margin:8px 0 8px; text-shadow:1px 1px 10px rgba(0,0,0,0.6); line-height:1.05; }
.poem{
  font-size:1.05rem; max-width:720px; margin:0 auto 18px; white-space: pre-line;
  text-shadow:1px 1px 6px rgba(0,0,0,0.6);
  color:#fff;
  background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.06));
  padding:12px 14px; border-radius:12px;
}
.main-btn{
  padding:12px 26px; font-size:1rem; border:none; border-radius:25px;
  background:white; color:var(--accent); font-weight:800; cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,0.25);
}
.main-btn:hover{ transform: scale(1.03); }
.click-counter{ font-size:1rem; margin:10px 0; text-shadow: 1px 1px 6px rgba(0,0,0,0.5); }
footer{ margin-top:14px; font-size:0.95rem; color:#fff; opacity:0.95; }

/* Hearts */
.heart{ position:absolute; width:18px; height:18px; background:var(--accent); transform:rotate(45deg); animation:floatUp 4s linear infinite; opacity:.9; pointer-events:none; }
.heart::before,.heart::after{ content:""; position:absolute; width:18px; height:18px; background:var(--accent); border-radius:50%; }
.heart::before{ top:-9px; left:0; } .heart::after{ left:-9px; top:0; }
@keyframes floatUp{0%{transform:translateY(0) rotate(45deg);opacity:1}100%{transform:translateY(-620px) rotate(45deg);opacity:0}}

/* Toast */
.toast{ position: fixed; left:50%; bottom:-90px; transform:translateX(-50%) scale(.95); background:rgba(0,0,0,0.85); color:white; padding:12px 22px; border-radius:26px; font-weight:700; z-index:1200; opacity:0; transition: all .35s cubic-bezier(.2,.9,.2,1); white-space:nowrap; }
.toast.show{ bottom:36px; opacity:1; transform:translateX(-50%) scale(1); }

/* Upload box */
.upload-box{ margin:18px auto; padding:16px; border-radius:12px; max-width: var(--max-content-width); background: rgba(255,245,246,0.95); color:#222; border:2px dashed var(--accent); }
label.upload-btn{ display:inline-block; padding:10px 16px; background: var(--accent); color:white; border-radius:10px; font-weight:800; cursor:pointer; }
label.upload-btn:hover{ background: var(--accent-dark); }

#uploadStatus{ margin-top:12px; text-align:left; }
.status-item{ margin:8px 0; background:#fff; color:#111; padding:8px 10px; border-radius:8px; display:flex; gap:12px; align-items:center; justify-content:space-between; overflow-wrap:anywhere; }
.status-left{ flex:1; text-align:left; word-break:break-word; }
.status-right{ min-width:70px; text-align:right; color:#555; font-weight:700; }

/* Gallery */
#gallery{ width:92%; max-width: var(--max-content-width); margin:18px auto 80px; display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:14px; }
.photo{ position:relative; border-radius:12px; overflow:hidden; background: rgba(0,0,0,0.06); box-shadow:0 10px 30px rgba(0,0,0,0.35); }
.photo img{ width:100%; height:100%; display:block; object-fit:cover; }
.caption{ position:absolute; left:8px; right:8px; bottom:8px; background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,0.55)); color:white; padding:8px 10px; border-radius:8px; display:flex; justify-content:space-between; gap:8px; align-items:center; }
.remove-btn{ background: rgba(255,255,255,0.12); color:white; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:700; }
.remove-btn:hover{ background: rgba(255,255,255,0.22); }

/* responsiveness */
@media(max-width:640px){ :root{--nav-height:56px} body{padding-top:var(--nav-height)} h1{font-size:1.7rem} .poem{font-size:0.98rem} .upload-box{padding:12px} nav button{min-width:74px;padding:8px 12px} }
</style>
</head>
<body>

<nav>
  <button class="tab-btn active" data-tab="home">–ì–ª–∞–≤–Ω–∞—è</button>
  <button class="tab-btn" data-tab="gallery">–ì–∞–ª–µ—Ä–µ—è</button>
  <button class="tab-btn" data-tab="upload">–ó–∞–≥—Ä—É–∑–∫–∞</button>
</nav>

<div id="loveToast" class="toast">–ò –ë–£–î–£ –õ–Æ–ë–ò–¢–¨ –í–°–ï–ì–î–ê üíñ</div>

<!-- HOME -->
<div id="home" class="tab active">
  <h1>–ó–µ—Ñ–∏—Ä–∫–∞ –º–æ—è,<br> —è —Ç–µ–±—è –ª—é–±–ª—é ‚ù§Ô∏è</h1>
  <div class="poem">
–Ø –æ —Ç–µ–±–µ, –∫—Ç–æ –º–Ω–µ –≤—Å–µ–≥–æ –¥–æ—Ä–æ–∂–µ,
–±–æ—é—Å—å –ø–∏—Å–∞—Ç—å.
–í–¥—Ä—É–≥ –∫—Ç–æ-–Ω–∏–±—É–¥—å, –ª—é–±—è,
–∑–∞–≥–æ–≤–æ—Ä–∏—Ç —Å –¥—Ä—É–≥–æ–π,
–ª—é–±–∏–º–æ–π —Ç–æ–∂–µ,
—Å–ª–æ–≤–∞–º–∏, —á—Ç–æ –Ω–∞—à—ë–ª
—è –¥–ª—è —Ç–µ–±—è.
–°–ø–∞—Å–∏–±–æ —Ç–µ–±–µ, —á—Ç–æ —Ç—ã –µ—Å—Ç—å –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏ üíï
  </div>
  <button class="main-btn" id="mainBtn">–ù–∞–∂–º–∏ –º–µ–Ω—è</button>
  <div class="click-counter">–ö–ª–∏–∫–æ–≤: <span id="clickCounter">0</span></div>
  <footer>–ï—Å–ª–∏ –≤–¥—Ä—É–≥ —Ç—ã —Å—Ç–∞–ª–∞ –∑–∞–±—ã–≤–∞—Ç—å, –∫–∞–∫ —è —Ç–µ–±—è –ª—é–±–ª—é, –æ–Ω –±—É–¥–µ—Ç –∑–¥–µ—Å—å –≤—Å–µ–≥–¥–∞ üåπ</footer>
</div>

<!-- GALLERY -->
<div id="gallery" class="tab" aria-live="polite"></div>

<!-- UPLOAD -->
<div id="upload" class="tab">
  <div class="upload-box">
    <h3 style="margin:0 0 8px 0; color:#222;">–í—ã–±–µ—Ä–∏ —Ñ–æ—Ç–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ üíñ</h3>
    <input type="file" id="fileInput" accept="image/*" multiple />
    <label for="fileInput" class="upload-btn">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</label>
    <div id="uploadStatus" aria-live="polite"></div>
  </div>
</div>

<script type="module">
/* -----------------------
   Supabase + IMGBB final, checked
   ----------------------- */

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// === –¢–≤–æ–∏ –∫—Ä–µ–¥—ã (–∫–∞–∫ —Ç—ã –¥–∞–ª) ===
const SUPABASE_URL = "https://pikpwcilgcudrzldsirq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpa3B3Y2lsZ2N1ZHJ6bGRzaXJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMjExMDMsImV4cCI6MjA3MTU5NzEwM30.LroYNNZdmUikcEo5vKWUIqOEI0bJpgM_l8f5SpZq5GA";
const IMGBB_API_KEY = "876c7823f9f0a390dbd7586dca84c168";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Tabs */
const tabBtns = document.querySelectorAll(".tab-btn");
const tabs = document.querySelectorAll(".tab");
tabBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    tabBtns.forEach(b=>b.classList.remove("active"));
    tabs.forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    const targetId = btn.dataset.tab;
    const target = document.getElementById(targetId);
    if(target) target.classList.add("active");
    window.scrollTo({top:0, behavior:"smooth"});
  });
});

/* Click counter (persist in localStorage) */
const counterElement = document.getElementById("clickCounter");
let count = parseInt(localStorage.getItem("zeffirkaClicks")) || 0;
counterElement.textContent = count;

const toast = document.getElementById("loveToast");
let toastAnimating=false;
function showToast(){
  if(toastAnimating) return;
  toastAnimating=true;
  toast.classList.remove("show");
  void toast.offsetWidth;
  toast.classList.add("show");
  setTimeout(()=>{ toast.classList.remove("show"); setTimeout(()=>{ toastAnimating=false },380); }, 2400);
}
document.getElementById("mainBtn").addEventListener("click", ()=> {
  count++;
  counterElement.textContent = count;
  localStorage.setItem("zeffirkaClicks", count);
  showToast();
});

/* Hearts */
function createHeart(){
  const heart = document.createElement("div");
  heart.className = "heart";
  heart.style.left = (Math.random()*(window.innerWidth-40)) + "px";
  heart.style.top = (window.innerHeight + 20) + "px";
  document.body.appendChild(heart);
  setTimeout(()=> heart.remove(), 4200);
}
setInterval(createHeart, 520);

/* Gallery: load from Supabase only */
const gallery = document.getElementById("gallery");

async function loadGallery(){
  gallery.innerHTML = "";
  try {
    const { data, error } = await supabase
      .from("photos")
      .select("id,name,url,created_at")
      .order("created_at", { ascending: true }); // —Å—Ç–∞—Ä—ã–µ ‚Äî –≤ –Ω–∞—á–∞–ª–µ
    if (error) throw error;
    if (!Array.isArray(data) || data.length === 0) {
      const hint = document.createElement("div");
      hint.style.color = "rgba(255,255,255,0.95)";
      hint.style.margin = "12px";
      hint.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ.";
      gallery.appendChild(hint);
      return;
    }
    for (const item of data) {
      appendPhotoToGallery(item);
    }
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥–∞–ª–µ—Ä–µ–∏ –∏–∑ Supabase:", err);
    const errMsg = document.createElement("div");
    errMsg.style.color = "rgba(255,255,255,0.95)";
    errMsg.style.margin = "12px";
    errMsg.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–∞–ª–µ—Ä–µ—é (—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å).";
    gallery.appendChild(errMsg);
  }
}

function appendPhotoToGallery(photo){
  // photo: {id, name, url, created_at}
  const wrapper = document.createElement("div");
  wrapper.className = "photo";

  const img = document.createElement("img");
  img.src = photo.url;
  img.alt = photo.name || "–§–æ—Ç–æ";
  img.loading = "lazy";
  wrapper.appendChild(img);

  const caption = document.createElement("div");
  caption.className = "caption";

  const left = document.createElement("div");
  left.textContent = photo.name || "";

  const right = document.createElement("div");
  right.style.display = "flex";
  right.style.gap = "8px";
  right.style.alignItems = "center";

  const dateSpan = document.createElement("div");
  dateSpan.style.fontSize = "0.82rem";
  dateSpan.style.opacity = "0.95";
  if (photo.created_at) {
    try { dateSpan.textContent = new Date(photo.created_at).toLocaleString(); } catch(e){ dateSpan.textContent = ""; }
  }

  const delBtn = document.createElement("button");
  delBtn.className = "remove-btn";
  delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
  delBtn.addEventListener("click", async (ev) => {
    ev.stopPropagation();
    if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏? (—É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ imgbb –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)")) return;
    try {
      const { error } = await supabase.from("photos").delete().eq("id", photo.id);
      if (error) throw error;
      wrapper.remove();
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ Supabase:", err);
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å).");
    }
  });

  right.appendChild(dateSpan);
  right.appendChild(delBtn);

  caption.appendChild(left);
  caption.appendChild(right);
  wrapper.appendChild(caption);

  gallery.appendChild(wrapper);
}

/* Upload handling: only IMGBB + Supabase.
   - No localStorage fallbacks for photos.
   - No image preview in upload area (only filename + percent).
   - Add to gallery only after Supabase insert succeeds.
*/
const fileInput = document.getElementById("fileInput");
const statusDiv = document.getElementById("uploadStatus");

fileInput.addEventListener("change", async () => {
  const files = Array.from(fileInput.files || []);
  if (!files.length) return;
  // clear statuses (but keep gallery as-is)
  statusDiv.innerHTML = "";

  for (const file of files) {
    // status row
    const statusItem = document.createElement("div");
    statusItem.className = "status-item";
    const left = document.createElement("div"); left.className = "status-left"; left.textContent = file.name;
    const right = document.createElement("div"); right.className = "status-right"; right.textContent = "0%";
    statusItem.appendChild(left); statusItem.appendChild(right);
    statusDiv.appendChild(statusItem);

    // upload via XHR to imgbb for progress
    try {
      const urlFromImgbb = await uploadToImgbb(file, pct => {
        right.textContent = pct + "%";
      });

      right.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";

      // insert into supabase and only then show in gallery
      const record = { name: file.name, url: urlFromImgbb };
      const { data, error } = await supabase
        .from("photos")
        .insert([record])
        .select()
        .single(); // return inserted row
      if (error) {
        console.error("–û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –≤ Supabase:", error);
        right.textContent = "–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏";
        // do NOT append to gallery
        continue;
      }
      // success: append to gallery
      right.textContent = "–ì–æ—Ç–æ–≤–æ";
      appendPhotoToGallery(data);
    } catch (err) {
      console.error("Upload workflow error:", err);
      // update status to error
      statusItem.querySelector(".status-right").textContent = "–û—à–∏–±–∫–∞";
    }
  }

  // clear file input to allow same file again
  fileInput.value = "";
});

/* helper: upload a File to imgbb via XHR, returns image url string */
function uploadToImgbb(file, onProgress){
  return new Promise((resolve, reject) => {
    const form = new FormData();
    form.append("image", file);

    const xhr = new XMLHttpRequest();
    xhr.open("POST", `https://api.imgbb.com/1/upload?key=${encodeURIComponent(IMGBB_API_KEY)}`);

    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const pct = Math.round((e.loaded / e.total) * 100);
        try { if (onProgress) onProgress(pct); } catch(_) {}
      }
    };

    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          const resp = JSON.parse(xhr.responseText);
          if (resp && resp.success && resp.data && resp.data.url) {
            resolve(resp.data.url);
          } else {
            reject(new Error("Bad response from imgbb"));
          }
        } catch (err) {
          reject(err);
        }
      } else {
        reject(new Error("HTTP " + xhr.status));
      }
    };

    xhr.onerror = () => reject(new Error("Network error uploading to imgbb"));
    xhr.send(form);
  });
}

/* initial load */
loadGallery();

</script>
</body>
</html>
